import{_ as a,c as i,o as n,ag as e}from"./chunks/framework.1L-BeKqY.js";const c=JSON.parse('{"title":"CLI and Tasks","description":"","frontmatter":{},"headers":[],"relativePath":"cli.md","filePath":"cli.md"}'),t={name:"cli.md"};function p(l,s,h,o,r,d){return n(),i("div",null,s[0]||(s[0]=[e(`<h1 id="cli-and-tasks" tabindex="-1">CLI and Tasks <a class="header-anchor" href="#cli-and-tasks" aria-label="Permalink to &quot;CLI and Tasks&quot;">​</a></h1><p>Your app will likely need command-line or non-browser-based tasks. Outside of standard needs like running a dev server or managing the database, you will have app-specific needs, like transforming data or performing one-time bulk operations.</p><p>In Brut, these are done as Ruby CLI apps, powered by the standard library&#39;s <code>OptionParser</code>.</p><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>The various commands installed with your Brut app in <code>bin/</code> are powered by Brut&#39;s CLI support. You can use this support to create your own tasks.</p><p>The main feature this provides is a consistent startup of your app&#39;s internals and configuration. This startup is almost exactly the same as the web app, so you can safely rely on connections to the database, the ability to queue jobs, or the behavior of your business logic. There&#39;s just no web server and no front-end.</p><h3 id="brut-cli-user-interface" tabindex="-1">Brut CLI User Interface <a class="header-anchor" href="#brut-cli-user-interface" aria-label="Permalink to &quot;Brut CLI User Interface&quot;">​</a></h3><p>All Brut CLI apps produce a user interface that should be familiar if you&#39;ve used CLI apps that support subcommands, like <code>git</code>:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&gt; git status</span></span>
<span class="line"><span>&gt; git checkout</span></span>
<span class="line"><span>&gt; git commit</span></span></code></pre></div><p>Each Brut CLI invocation has six parts:</p><ul><li>The executable, e.g. <code>bin/db</code></li><li><em>Global Options</em> which are strings that start witih one or two dashes and control the behavior of the entire app, e.g. <code>--log-level=debug</code> These are optional and there can be any number of them.</li><li>The subcommand, which is a single string indicating what actual function to perform, e.g. <code>rebuild</code> in <code>bin/db rebuild</code></li><li><em>Command Options</em> which are just like global options, but they come <em>after</em> the command and apply only to that command</li><li>Arguments, which are any strings left over after the <em>command options</em> are parsed.</li></ul><p>All of this is powered by Ruby&#39;s <code>OptionParser</code>, which results in a canonical, UNIX-like UI.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&gt; bin/my_cli --global-option list --command-option arg1 arg2</span></span>
<span class="line"><span>  \\----+---/ \\-------+-----/ \\-+/ \\--------+-----/ \\---+---/</span></span>
<span class="line"><span>       |             |         |           |           |</span></span>
<span class="line"><span>   Executable        |         |           |           |</span></span>
<span class="line"><span>                     |         |           |           |</span></span>
<span class="line"><span>                Command        |           |           |</span></span>
<span class="line"><span>                   Options     |                       |</span></span>
<span class="line"><span>                               |           |           |</span></span>
<span class="line"><span>                             Subcommand    |           |</span></span>
<span class="line"><span>                                           |           |</span></span>
<span class="line"><span>                                      Command          |</span></span>
<span class="line"><span>                                        Options        |</span></span>
<span class="line"><span>                                                       |</span></span>
<span class="line"><span>                                                       |</span></span>
<span class="line"><span>                                                    Arguments</span></span></code></pre></div><p>Brut CLI apps all respond to <code>-h</code> and <code>--help</code> to view the list of subcommands, global options, and any environment variables that affect the behavior.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&gt; bin/db -h </span></span>
<span class="line"><span>bin/db [global options] commands [command options] [args]</span></span>
<span class="line"><span></span></span>
<span class="line"><span>   Manage your database in development, test, and production</span></span>
<span class="line"><span></span></span>
<span class="line"><span>GLOBAL OPTIONS</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -h, --help                       Get help</span></span>
<span class="line"><span>        --log-level=LEVEL            Set log level. Allowed values: debug, info, warn, error, fatal. Default &#39;fatal&#39;</span></span>
<span class="line"><span>        --verbose                    Set log level to &#39;debug&#39;, which will produce maximum output</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ENVIRONMENT VARIABLES</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    BRUT_CLI_RAISE_ON_ERROR - if set, shows backtrace on errors</span></span>
<span class="line"><span>    LOG_LEVEL               - log level if --log-level or --verbose is omitted</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>COMMANDS</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    help          - Get help on a command</span></span>
<span class="line"><span>    create        - Create the database if it does not exist</span></span>
<span class="line"><span>    drop          - Drop the database if it exists</span></span>
<span class="line"><span>    migrate       - Apply any outstanding migrations to the database</span></span>
<span class="line"><span>    new_migration - Create a new migration file</span></span>
<span class="line"><span>    rebuild       - Drop, re-create, and run migrations, effecitvely rebuilding the entire database</span></span>
<span class="line"><span>    seed          - Load seed data into the database</span></span>
<span class="line"><span>    status        - Check the status of the database and migrations</span></span></code></pre></div><p>Brut CLI apps also support the subcommand <code>help</code> which will show help on a given subcommand, including the command options and arguments.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&gt;  bin/db help rebuild</span></span>
<span class="line"><span>Usage: bin/db [global options] rebuild [command options] </span></span>
<span class="line"><span></span></span>
<span class="line"><span>    Drop, re-create, and run migrations, effecitvely rebuilding the entire database</span></span>
<span class="line"><span></span></span>
<span class="line"><span>GLOBAL OPTIONS</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    -h, --help                       Get help</span></span>
<span class="line"><span>        --log-level=LEVEL            Set log level. Allowed values: debug, info, warn, error, fatal. Default &#39;fatal&#39;</span></span>
<span class="line"><span>        --verbose                    Set log level to &#39;debug&#39;, which will produce maximum output</span></span>
<span class="line"><span></span></span>
<span class="line"><span>ENVIRONMENT VARIABLES</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    BRUT_CLI_RAISE_ON_ERROR - if set, shows backtrace on errors</span></span>
<span class="line"><span>    LOG_LEVEL               - log level if --log-level or --verbose is omitted</span></span>
<span class="line"><span>    RACK_ENV                - default project environment when --env is omitted</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>COMMAND OPTIONS</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        --env=ENVIRONMENT            Project environment (default &#39;development&#39;)</span></span></code></pre></div><p>All of this means that the bulk of CLI-specific code you will write is specifying these options and documentation, then deferring to your business logic.</p><h3 id="basic-cli" tabindex="-1">Basic CLI <a class="header-anchor" href="#basic-cli" aria-label="Permalink to &quot;Basic CLI&quot;">​</a></h3><p>Every CLI app is a class that extends <a href="/api/Brut/CLI/App.html" target="_self" rel="noopener" data-no-router><code>Brut::CLI::App</code></a>. This class should contain one inner class for each subcommand. Those classes should extend <a href="/api/Brut/CLI/App.html" target="_self" rel="noopener" data-no-router><code>Brut::CLI::App</code></a>.</p><p>Inside your <a href="/api/Brut/CLI/App.html" target="_self" rel="noopener" data-no-router><code>Brut::CLI::App</code></a> class, you can call a few class methods to declare aspects of the UI. In particular, <code>opts</code> returns the <code>OptionParser</code> in play that you can use to declare global options. Unlike <code>OptionParser</code>&#39;s <code>on</code> method, Brut&#39;s does not require providing a block. Brut will store the runtime options in a hash (see below).</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MyAppCLI</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Brut</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CLI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">App</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  description </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;My awesome command line app&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  opts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--dry-run&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Only show what would happen; don&#39;t change anything&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  opts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--status STATUS&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Set the status you&#39;d like to see&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>This code means your app&#39;s global options are <code>--dry-run</code>, which will not accept an argument, and <code>--status</code> which <em>must</em> be given an argument. The arguments to <code>on</code> are the same as those for Ruby&#39;s <code>OptionParser</code>.</p><p>Declaring subcommands provides a similar API. Let&#39;s say our app has a &quot;status&quot; subcommand, and a &quot;run&quot; subcommand.</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MyAppCLI</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Brut</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CLI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">App</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  description </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;My awesome command line app&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  opts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--dry-run&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Only show what would happen; don&#39;t change anything&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  opts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--status STATUS&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Set the status you&#39;d like to see&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  class</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Brut</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CLI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Command</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    description </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Show the status&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    args </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;files to get the status of&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    opts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-l&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--long&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Show long-format&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  class</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Run</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Brut</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CLI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Command</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    description </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Run any outstanding tasks&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    opts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--exit-status STATUS&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Exit status on success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>This enables commands like <code>bin/my_app status -l foo.txt bar.rb</code> or <code>bin/my_app status --exit-status=3</code>.</p><p>The names are derived from the class name. You can override them by using <code>command_name</code> inside a command class.</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Run</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Brut</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CLI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Command</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  command_name </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;exec&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>The only thing left is to specify what happens for each subcommand. To do that, implement <code>execute</code>.</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Brut</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CLI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Command</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  description </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Show the status&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  args </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;files to get the status of&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  opts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;-l&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--long&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Show long-format&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> execute</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # ...</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Run</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Brut</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CLI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Command</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  description </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Run any outstanding tasks&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  opts.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">on</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;--exit-status STATUS&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Exit status on success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> execute</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # ...</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="implementing-execute" tabindex="-1">Implementing <code>execute</code> <a class="header-anchor" href="#implementing-execute" aria-label="Permalink to &quot;Implementing \`execute\`&quot;">​</a></h3><p>Once <code>execute</code> is called, your app&#39;s internals will have been setup and bootstrapped. That means all you data models can access the database, and any other setup will have ocurred. Generally, <code>execute</code> can then have whatever code makes sense.</p><p>That said, <code>execute</code> has access to a few values to understand the command line invocation and to support testing.</p><ul><li><code>#options</code> - the command options passed on the command line, as a <a href="/api/Brut/CLI/Options.html" target="_self" rel="noopener" data-no-router><code>Brut::CLI::Options</code></a></li><li><code>#global_options</code> - the global options passed on the command line, as a <a href="/api/Brut/CLI/Options.html" target="_self" rel="noopener" data-no-router><code>Brut::CLI::Options</code></a></li><li><code>#args</code> - the args passed on the command line, as an array of strings</li><li><code>#out</code> - an IO you should use to print messages to the standard out.</li><li><code>#err</code> - on IO you should use to print messages to the standard error.</li><li><code>#system!</code> - the method you should use to spawn child processes. This is preferable to <code>Kernel.system</code> because the command executed will be logged, and your app will raise if the command fails. This makes it more straightfoward to safely script other command line invocations.</li></ul><h3 id="advanced-options" tabindex="-1">Advanced Options <a class="header-anchor" href="#advanced-options" aria-label="Permalink to &quot;Advanced Options&quot;">​</a></h3><p>The API documentation will show you other options for creating your CLI UI, but there are a few aspects to highlight.</p><ul><li>Calling <code>configure_only!</code> in your app, will run your app&#39;s subcommands without starting up Brut. This is generally not needed, but can be useful if you want to do basic scripting without worrying about connecting to the database.</li><li><code>default_command</code> can be used to specify the command to run if none is given. <code>bin/test</code> uses this to run <code>bin/test run</code>.</li><li><code>requires_project_env</code> can be used at the app or command level to indicate that <code>--env</code> is accepted on the command line to set the project environment for the code to run in. Omitting this means that the actual project env used when the app runs is undefined.</li><li>Use <code>env_var</code> to document environment variables your app will use that affect its behavior.</li></ul><h3 id="the-file-in-bin" tabindex="-1">The file in <code>bin</code> <a class="header-anchor" href="#the-file-in-bin" aria-label="Permalink to &quot;The file in \`bin\`&quot;">​</a></h3><p>Currently, Brut doesn&#39;t provide a way to create this file, but it&#39;s relatively straightforward. It&#39;s almost entirely boilerplate except for your class:</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/usr/bin/env ruby</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">require</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;bundler&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Bundler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">require</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">require</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;pathname&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">require</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;brut/cli&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">APP_PATH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">join</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dirname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($0),</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;..&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;app&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;src&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> APP_PATH</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">require</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;cli/my_app&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Brut</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CLI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">app</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line highlighted"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  MyAppCLI</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  project_root:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Pathname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">($0).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dirname</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;..&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h2 id="testing" tabindex="-1">Testing <a class="header-anchor" href="#testing" aria-label="Permalink to &quot;Testing&quot;">​</a></h2><p>Depending on how your CLI is impelmented, testing it may not be that beneficial. If <code>execute</code> simply defers to your back-end, your tests of that back-end will generally suffice.</p><p>That said, your command classes are normal Ruby classes, so you can test them in a conventional way.</p><p>The initalizer of each command class looks like so:</p><div class="language-ruby vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ruby</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> initialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  command_options:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  global_options:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  args:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  out:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  err:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  executor:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p><code>command_options</code> and <code>global_options</code> accept a <a href="/api/Brut/CLI/Options.html" target="_self" rel="noopener" data-no-router><code>Brut::CLI::Options</code></a>, which can be created with a Hash to represent the parsed command line options.</p><p><code>args</code> is a list of Strings. <code>out</code> and <code>err</code> are IOs, so you can use the standard library&#39;s <code>StringIO</code> to both capture the output and supress it from your test&#39;s standard output/error.</p><p><code>executor</code> is a <a href="/api/Brut/CLI/Executor.html" target="_self" rel="noopener" data-no-router><code>Brut::CLI::Executor</code></a>, which is a wrapper around the standard library&#39;s <code>Open3</code>. You can mock this to set expectations on what child processes are launched and how they behave.</p><h2 id="recommended-practices" tabindex="-1">Recommended Practices <a class="header-anchor" href="#recommended-practices" aria-label="Permalink to &quot;Recommended Practices&quot;">​</a></h2><p><code>execute</code> should defer to classes in your back-end, ideally a single method of a single class. Excessive logic or UI in your CLI will be hard to test and maintain.</p><h2 id="technical-notes" tabindex="-1">Technical Notes <a class="header-anchor" href="#technical-notes" aria-label="Permalink to &quot;Technical Notes&quot;">​</a></h2><div class="important custom-block github-alert"><p class="custom-block-title">IMPORTANT</p><p>Technical Notes are for deeper understanding and debugging. While we will try to keep them up-to-date with changes to Brut&#39;s internals, the source code is always more correct.</p></div><p><em>Last Updated May 9, 2025</em></p>`,53)]))}const u=a(t,[["render",p]]);export{c as __pageData,u as default};
